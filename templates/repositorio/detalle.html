{% extends 'base.html' %}
{% load static %}

{% block title %}{{ proyecto.titulo }} — OASIS Repositorio{% endblock %}

{% block three_canvas %}{% endblock %}

{% block extra_head %}
<style>
    /* ─── Detail Layout ─────────────────────────────── */
    .detail-hero {
        background: linear-gradient(135deg, #064e3b 0%, #047857 40%, #059669 100%);
        position: relative;
        overflow: hidden;
    }
    .detail-hero::before {
        content: '';
        position: absolute;
        top: -40%; right: -15%;
        width: 400px; height: 400px;
        background: radial-gradient(circle, rgba(249,115,22,0.12), transparent 70%);
        border-radius: 50%;
    }

    /* ─── Smart Preview Container ───────────────────── */
    .preview-container {
        background: #1f2937;
        border-radius: 1rem;
        overflow: hidden;
        min-height: 300px;
        position: relative;
    }
    .preview-container.preview-code {
        background: #0d1117;
    }
    .preview-container.preview-gallery {
        background: #111827;
    }
    .preview-container.preview-3d {
        background: linear-gradient(180deg, #1a1a2e, #16213e);
    }
    .preview-container.preview-video {
        background: #000;
    }
    .preview-container.preview-document {
        background: #f9fafb;
    }

    /* Code viewer */
    .code-preview {
        padding: 1.5rem;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.8rem;
        line-height: 1.6;
        color: #e6edf3;
        overflow-x: auto;
        max-height: 400px;
        overflow-y: auto;
    }
    .code-line-num {
        color: #484f58;
        user-select: none;
        text-align: right;
        padding-right: 1rem;
        min-width: 2.5rem;
        display: inline-block;
    }

    /* Gallery grid */
    .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 0.5rem;
        padding: 0.5rem;
    }
    .gallery-item {
        border-radius: 0.5rem;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
        aspect-ratio: 4/3;
    }
    .gallery-item:hover { transform: scale(1.02); }
    .gallery-item img {
        width: 100%; height: 100%;
        object-fit: cover;
    }

    /* 3D placeholder */
    .preview-3d-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 350px;
        color: #8b5cf6;
    }
    .preview-3d-content i { font-size: 4rem; margin-bottom: 1rem; }

    /* Video embed */
    .video-wrapper {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
    }
    .video-wrapper iframe, .video-wrapper video {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
    }

    /* PDF viewer */
    .pdf-frame {
        width: 100%;
        min-height: 500px;
        border: none;
    }

    /* ─── File list ─────────────────────────────────── */
    .file-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        border: 1px solid #f3f4f6;
        background: #fff;
        transition: all 0.2s;
    }
    .file-item:hover {
        border-color: #d1fae5;
        background: #f9fafb;
    }
    .file-icon {
        width: 2.5rem; height: 2.5rem;
        border-radius: 0.5rem;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }
    .file-info { flex: 1; min-width: 0; }
    .file-name {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #111827;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .file-meta {
        font-size: 0.7rem;
        color: #9ca3af;
        display: flex;
        gap: 0.75rem;
        margin-top: 0.15rem;
    }
    .scan-badge {
        font-size: 0.6rem;
        font-weight: 700;
        padding: 0.1rem 0.4rem;
        border-radius: 9999px;
    }
    .scan-clean { background: #ecfdf5; color: #059669; }
    .scan-pending { background: #fef3c7; color: #92400e; }
    .scan-suspicious { background: #fef2f2; color: #ef4444; }

    /* ─── Info cards ────────────────────────────────── */
    .info-card {
        background: #fff;
        border: 1px solid #f3f4f6;
        border-radius: 1rem;
        padding: 1.25rem;
    }
    .info-label {
        font-size: 0.65rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #9ca3af;
        margin-bottom: 0.25rem;
    }
    .info-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: #111827;
    }

    /* ─── Stats bar ─────────────────────────────────── */
    .stat-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.75rem;
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(8px);
        border-radius: 9999px;
        color: #fff;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* ─── Vote button ───────────────────────────────── */
    .vote-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1.25rem;
        border-radius: 9999px;
        font-weight: 700;
        font-size: 0.85rem;
        transition: all 0.3s;
        cursor: pointer;
        border: 2px solid transparent;
    }
    .vote-btn:not(.voted) {
        background: #fff;
        color: #ef4444;
        border-color: #fecaca;
    }
    .vote-btn:not(.voted):hover {
        background: #fef2f2;
        border-color: #ef4444;
        transform: scale(1.05);
    }
    .vote-btn.voted {
        background: #ef4444;
        color: #fff;
    }

    /* ─── Related cards ─────────────────────────────── */
    .related-card {
        background: #fff;
        border: 1px solid #f3f4f6;
        border-radius: 0.75rem;
        padding: 1rem;
        transition: all 0.2s;
        text-decoration: none;
        display: block;
    }
    .related-card:hover {
        border-color: #d1fae5;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    /* ─── Lightbox ──────────────────────────────────── */
    .lightbox {
        position: fixed;
        inset: 0;
        z-index: 60;
        background: rgba(0,0,0,0.9);
        display: none;
        align-items: center;
        justify-content: center;
    }
    .lightbox.active { display: flex; }
    .lightbox img {
        max-width: 90%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 0.5rem;
    }
    .lightbox-close {
        position: absolute;
        top: 1rem; right: 1rem;
        color: #fff;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 61;
        background: rgba(0,0,0,0.5);
        width: 2.5rem; height: 2.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* ─── Upload modal ──────────────────────────────── */
    .upload-modal-bg {
        position: fixed;
        inset: 0;
        z-index: 55;
        background: rgba(0,0,0,0.4);
        display: none;
        align-items: center;
        justify-content: center;
    }
    .upload-modal-bg.active { display: flex; }
    .upload-modal {
        background: #fff;
        border-radius: 1rem;
        padding: 2rem;
        width: 90%;
        max-width: 32rem;
        box-shadow: 0 25px 50px rgba(0,0,0,0.15);
    }
    .drop-zone {
        border: 2px dashed #d1d5db;
        border-radius: 0.75rem;
        padding: 2rem;
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
    }
    .drop-zone:hover, .drop-zone.drag-over {
        border-color: #059669;
        background: #ecfdf5;
    }

    /* ─── Watermark ─────────────────────────────────── */
    .watermark-overlay {
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 5;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.06;
        font-size: 3rem;
        font-weight: 900;
        color: #000;
        transform: rotate(-30deg);
        user-select: none;
        letter-spacing: 0.1em;
    }
</style>
{% endblock %}

{% block navbar %}
{% include 'partials/navbar_auth.html' %}
{% endblock %}

{% block content %}
<!-- ═══ Hero / Header ════════════════════════════════════════ -->
<section class="detail-hero pt-24 pb-10 px-4">
    <div class="max-w-5xl mx-auto relative z-10">
        <!-- Breadcrumb -->
        <nav class="flex items-center gap-2 text-emerald-200 text-xs mb-6">
            <a href="{% url 'repositorio:explorador' %}" class="hover:text-white transition">Repositorio</a>
            <i class="fa-solid fa-chevron-right text-emerald-400" style="font-size:0.5rem;"></i>
            <a href="{% url 'repositorio:explorador' %}?cluster={{ proyecto.cluster }}" class="hover:text-white transition">{{ proyecto.cluster_display }}</a>
            <i class="fa-solid fa-chevron-right text-emerald-400" style="font-size:0.5rem;"></i>
            <span class="text-white">{{ proyecto.titulo|truncatechars:40 }}</span>
        </nav>

        <!-- Title -->
        <h1 class="text-2xl sm:text-3xl font-black text-white leading-tight mb-2">
            {{ proyecto.titulo }}
            {% if proyecto.destacado %}
            <i class="fa-solid fa-star text-orange-400 text-lg ml-2"></i>
            {% endif %}
        </h1>

        <div class="flex flex-wrap items-center gap-3 text-emerald-100 text-sm mb-4">
            <span><i class="fa-solid fa-user mr-1"></i> {{ proyecto.autor }}</span>
            <span class="text-emerald-400">|</span>
            <span><i class="fa-solid fa-graduation-cap mr-1"></i> {{ proyecto.get_carrera_display }}</span>
            {% if proyecto.ficha %}
            <span class="text-emerald-400">|</span>
            <span><i class="fa-solid fa-id-card mr-1"></i> Ficha {{ proyecto.ficha }}</span>
            {% endif %}
            <span class="text-emerald-400">|</span>
            <span><i class="fa-solid fa-calendar mr-1"></i> {{ proyecto.anio }}</span>
        </div>

        <!-- Stats -->
        <div class="flex flex-wrap items-center gap-3">
            <span class="stat-pill"><i class="fa-solid fa-heart"></i> {{ proyecto.votos }} votos</span>
            <span class="stat-pill"><i class="fa-solid fa-download"></i> {{ proyecto.descargas }} descargas</span>
            <span class="stat-pill"><i class="fa-solid fa-eye"></i> {{ proyecto.vistas }} vistas</span>
            <span class="stat-pill"><i class="fa-solid fa-paperclip"></i> {{ archivos|length }} archivos</span>
            <span class="stat-pill" style="background:rgba(5,150,105,0.3);">
                <i class="fa-solid fa-tag"></i> {{ proyecto.get_version_actual_display }}
            </span>
            <span class="stat-pill" style="background:rgba(249,115,22,0.3);">
                {% if preview_type == 'CODE' %}<i class="fa-solid fa-code"></i>
                {% elif preview_type == 'MEDIA_3D' %}<i class="fa-solid fa-cube"></i>
                {% elif preview_type == 'GALLERY' %}<i class="fa-solid fa-images"></i>
                {% elif preview_type == 'VIDEO' %}<i class="fa-solid fa-film"></i>
                {% else %}<i class="fa-solid fa-file-alt"></i>{% endif %}
                {{ proyecto.preview_type_display }}
            </span>
        </div>
    </div>
</section>

<!-- ═══ Main Content ═════════════════════════════════════════ -->
<section class="max-w-5xl mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- ── Left Column (Preview + Description) ──── -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Smart Preview -->
            {% if archivos %}
            <div class="preview-container preview-{{ preview_type|lower }}" id="smart-preview">
                <!-- Dynamic watermark -->
                <div class="watermark-overlay">OASIS SENA</div>

                {% if preview_type == 'CODE' %}
                <!-- Code Preview -->
                <div class="code-preview" id="code-viewer">
                    <div class="flex items-center gap-3 mb-4 pb-3 border-b border-gray-700">
                        <span class="w-3 h-3 rounded-full bg-red-500"></span>
                        <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                        <span class="w-3 h-3 rounded-full bg-green-500"></span>
                        <span class="text-gray-400 text-xs ml-2">
                            {% if code_files %}{{ code_files.0.nombre_original }}{% else %}preview.py{% endif %}
                        </span>
                    </div>
                    {% if code_files %}
                    <p class="text-gray-400 text-xs mb-3">Archivo de codigo fuente disponible para descarga</p>
                    <div class="text-gray-300 text-sm">
                        <span class="code-line-num">1</span> <span style="color:#ff7b72;">"""</span><br>
                        <span class="code-line-num">2</span> <span style="color:#ff7b72;">Proyecto:</span> <span style="color:#a5d6ff;">{{ proyecto.titulo }}</span><br>
                        <span class="code-line-num">3</span> <span style="color:#ff7b72;">Autor:</span> <span style="color:#a5d6ff;">{{ proyecto.autor }}</span><br>
                        <span class="code-line-num">4</span> <span style="color:#ff7b72;">Carrera:</span> <span style="color:#a5d6ff;">{{ proyecto.get_carrera_display }}</span><br>
                        <span class="code-line-num">5</span> <span style="color:#ff7b72;">"""</span><br>
                        <span class="code-line-num">6</span><br>
                        <span class="code-line-num">7</span> <span style="color:#79c0ff;"># {{ code_files|length }} archivo(s) de codigo disponibles</span><br>
                        <span class="code-line-num">8</span> <span style="color:#79c0ff;"># Descarga los archivos para ver el codigo completo</span>
                    </div>
                    {% endif %}
                </div>

                {% elif preview_type == 'MEDIA_3D' %}
                <!-- 3D Model Preview -->
                <div class="preview-3d-content">
                    <i class="fa-solid fa-cube" style="animation: pulse 2s infinite;"></i>
                    <p class="text-lg font-bold text-purple-300">Vista Previa 3D</p>
                    <p class="text-sm text-purple-400 mt-1">Modelo 3D / Animacion</p>
                    {% if models_3d %}
                    <p class="text-xs text-gray-500 mt-3">{{ models_3d|length }} modelo(s) disponible(s) para descarga</p>
                    {% endif %}
                </div>

                {% elif preview_type == 'GALLERY' %}
                <!-- Image Gallery -->
                {% if images %}
                <div class="gallery-grid">
                    {% for img in images %}
                    <div class="gallery-item" onclick="openLightbox('{{ img.archivo.url }}')">
                        <img src="{{ img.archivo.url }}" alt="{{ img.nombre_original }}" loading="lazy">
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="flex items-center justify-center min-h-[300px] text-gray-500">
                    <div class="text-center">
                        <i class="fa-solid fa-images text-4xl mb-2 text-pink-300"></i>
                        <p class="text-sm">Galeria de imagenes</p>
                        <p class="text-xs text-gray-400 mt-1">Sube imagenes del proyecto para activar la galeria</p>
                    </div>
                </div>
                {% endif %}

                {% elif preview_type == 'VIDEO' %}
                <!-- Video Preview -->
                {% if proyecto.enlace_demo %}
                <div class="video-wrapper">
                    <iframe src="{{ proyecto.enlace_demo }}" allowfullscreen></iframe>
                </div>
                {% elif videos %}
                <div class="flex items-center justify-center min-h-[300px]">
                    <div class="text-center text-gray-400">
                        <i class="fa-solid fa-play-circle text-5xl mb-3 text-red-400"></i>
                        <p class="text-sm font-semibold text-white">{{ videos|length }} video(s) disponible(s)</p>
                        <p class="text-xs text-gray-500 mt-1">Descarga para ver el contenido completo</p>
                    </div>
                </div>
                {% else %}
                <div class="flex items-center justify-center min-h-[300px] text-gray-500">
                    <div class="text-center">
                        <i class="fa-solid fa-film text-4xl mb-2 text-red-300"></i>
                        <p class="text-sm">Produccion Audiovisual</p>
                    </div>
                </div>
                {% endif %}

                {% else %}
                <!-- Document Preview (default) -->
                {% if documents %}
                {% with first_doc=documents.0 %}
                {% if first_doc.extension == 'pdf' %}
                <iframe src="{{ first_doc.archivo.url }}" class="pdf-frame"></iframe>
                {% else %}
                <div class="flex items-center justify-center min-h-[300px]">
                    <div class="text-center text-gray-600">
                        <i class="fa-solid fa-file-pdf text-5xl mb-3 text-red-400"></i>
                        <p class="text-sm font-semibold">{{ first_doc.nombre_original }}</p>
                        <p class="text-xs text-gray-400 mt-1">{{ first_doc.size_display }}</p>
                    </div>
                </div>
                {% endif %}
                {% endwith %}
                {% else %}
                <div class="flex items-center justify-center min-h-[300px]" style="background:#f9fafb;">
                    <div class="text-center text-gray-500">
                        <i class="fa-solid fa-file-alt text-4xl mb-2"></i>
                        <p class="text-sm">Documento del proyecto</p>
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
            {% endif %}

            <!-- Description -->
            <div class="info-card">
                <h2 class="text-lg font-bold text-gray-800 mb-3">
                    <i class="fa-solid fa-align-left text-oasis-600 mr-2"></i>Descripcion
                </h2>
                {% if proyecto.resumen %}
                <p class="text-sm text-oasis-700 font-semibold bg-oasis-50 rounded-lg p-3 mb-3">
                    {{ proyecto.resumen }}
                </p>
                {% endif %}
                <div class="text-sm text-gray-600 leading-relaxed whitespace-pre-line">{{ proyecto.descripcion }}</div>
            </div>

            <!-- Files Section -->
            {% if archivos %}
            <div class="info-card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-800">
                        <i class="fa-solid fa-folder-open text-oasis-600 mr-2"></i>Archivos
                        <span class="text-sm font-normal text-gray-400 ml-1">({{ archivos|length }})</span>
                    </h2>
                    {% if can_edit %}
                    <button onclick="openUploadModal()" class="text-xs font-semibold text-oasis-600 hover:text-oasis-700 flex items-center gap-1">
                        <i class="fa-solid fa-upload"></i> Subir mas
                    </button>
                    {% endif %}
                </div>

                {% for version_name, version_files in archivos_by_version.items %}
                <div class="mb-4">
                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">
                        <i class="fa-solid fa-code-branch text-oasis-500 mr-1"></i>{{ version_name }}
                    </h4>
                    <div class="space-y-2">
                        {% for a in version_files %}
                        <div class="file-item">
                            <div class="file-icon">
                                <i class="fa-solid {{ a.icon_class }}"></i>
                            </div>
                            <div class="file-info">
                                <div class="file-name">{{ a.nombre_original }}</div>
                                <div class="file-meta">
                                    <span>{{ a.size_display }}</span>
                                    <span>{{ a.get_tipo_display }}</span>
                                    <span class="scan-badge scan-{{ a.scan_status }}">
                                        {% if a.scan_status == 'clean' %}<i class="fa-solid fa-shield-check mr-0.5"></i>Limpio
                                        {% elif a.scan_status == 'suspicious' %}<i class="fa-solid fa-triangle-exclamation mr-0.5"></i>Sospechoso
                                        {% else %}<i class="fa-solid fa-clock mr-0.5"></i>Pendiente{% endif %}
                                    </span>
                                </div>
                            </div>
                            {% if can_download and a.scan_status != 'suspicious' %}
                            <a href="{% url 'repositorio:descargar' a.pk %}" class="flex-shrink-0 px-3 py-1.5 bg-oasis-50 text-oasis-700 rounded-lg text-xs font-bold hover:bg-oasis-100 transition">
                                <i class="fa-solid fa-download mr-1"></i>Descargar
                            </a>
                            {% elif not can_download %}
                            <span class="flex-shrink-0 px-3 py-1.5 bg-gray-100 text-gray-400 rounded-lg text-xs font-bold">
                                <i class="fa-solid fa-lock mr-1"></i>Inicia sesion
                            </span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- ── Right Column (Info + Actions) ──────── -->
        <div class="space-y-4">

            <!-- Vote & Actions -->
            <div class="info-card text-center">
                {% if user.is_authenticated %}
                <button class="vote-btn w-full justify-center mb-3" id="vote-btn"
                        onclick="voteProject({{ proyecto.pk }})">
                    <i class="fa-solid fa-heart"></i>
                    <span id="vote-count">{{ proyecto.votos }}</span> votos
                </button>
                {% else %}
                <a href="{% url 'login' %}?next={% url 'repositorio:detalle' proyecto.pk %}"
                   class="vote-btn w-full justify-center mb-3">
                    <i class="fa-solid fa-heart"></i>
                    {{ proyecto.votos }} votos
                </a>
                {% endif %}

                {% if proyecto.enlace_repositorio %}
                <a href="{{ proyecto.enlace_repositorio }}" target="_blank" rel="noopener"
                   class="block w-full text-center px-4 py-2 bg-gray-900 text-white rounded-lg text-sm font-semibold hover:bg-gray-800 transition mb-2">
                    <i class="fa-brands fa-github mr-1"></i> Ver Repositorio
                </a>
                {% endif %}

                {% if proyecto.enlace_demo %}
                <a href="{{ proyecto.enlace_demo }}" target="_blank" rel="noopener"
                   class="block w-full text-center px-4 py-2 bg-oasis-600 text-white rounded-lg text-sm font-semibold hover:bg-oasis-700 transition">
                    <i class="fa-solid fa-external-link mr-1"></i> Ver Demo
                </a>
                {% endif %}
            </div>

            <!-- Project Info -->
            <div class="info-card space-y-3">
                <h3 class="text-sm font-bold text-gray-800 mb-2">
                    <i class="fa-solid fa-info-circle text-oasis-600 mr-1"></i>Informacion
                </h3>

                <div>
                    <div class="info-label">Carrera</div>
                    <div class="info-value text-sm">{{ proyecto.get_carrera_display }}</div>
                </div>

                <div>
                    <div class="info-label">Cluster</div>
                    <div class="info-value text-sm">
                        <span class="card-cluster cluster-{{ proyecto.cluster }} text-xs">{{ proyecto.cluster_display }}</span>
                    </div>
                </div>

                {% if proyecto.ficha %}
                <div>
                    <div class="info-label">Ficha</div>
                    <div class="info-value text-sm">{{ proyecto.ficha }}</div>
                </div>
                {% endif %}

                {% if proyecto.instructor_avalador %}
                <div>
                    <div class="info-label">Instructor Avalador</div>
                    <div class="info-value text-sm">{{ proyecto.instructor_avalador.get_full_name|default:proyecto.instructor_avalador.username }}</div>
                </div>
                {% endif %}

                <div>
                    <div class="info-label">Estado</div>
                    <div class="info-value text-sm">
                        {% if proyecto.estado == 'publicado' %}
                        <span class="inline-flex items-center gap-1 text-green-600"><i class="fa-solid fa-check-circle"></i> {{ proyecto.get_estado_display }}</span>
                        {% elif proyecto.estado == 'en_revision' %}
                        <span class="inline-flex items-center gap-1 text-yellow-600"><i class="fa-solid fa-clock"></i> {{ proyecto.get_estado_display }}</span>
                        {% else %}
                        <span class="text-gray-500">{{ proyecto.get_estado_display }}</span>
                        {% endif %}
                    </div>
                </div>

                <div>
                    <div class="info-label">Version</div>
                    <div class="info-value text-sm">{{ proyecto.get_version_actual_display }}</div>
                </div>

                <div>
                    <div class="info-label">Ano</div>
                    <div class="info-value text-sm">{{ proyecto.anio }}</div>
                </div>

                <div>
                    <div class="info-label">Publicado</div>
                    <div class="info-value text-sm">{{ proyecto.fecha_publicacion|date:"d M Y" }}</div>
                </div>
            </div>

            <!-- Tags / Tools -->
            {% if proyecto.tags_list or proyecto.tags.exists %}
            <div class="info-card">
                <h3 class="text-sm font-bold text-gray-800 mb-2">
                    <i class="fa-solid fa-tags text-oasis-600 mr-1"></i>Herramientas y Tags
                </h3>
                <div class="flex flex-wrap gap-1.5">
                    {% for t in proyecto.tags.all %}
                    <a href="{% url 'repositorio:explorador' %}?tag={{ t.slug }}"
                       class="px-2.5 py-1 bg-oasis-50 text-oasis-700 rounded-full text-xs font-semibold hover:bg-oasis-100 transition">
                        {{ t.nombre }}
                    </a>
                    {% endfor %}
                    {% for tag_name in proyecto.tags_list %}
                    <span class="px-2.5 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-semibold">
                        {{ tag_name }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Related Projects -->
            {% if related %}
            <div class="info-card">
                <h3 class="text-sm font-bold text-gray-800 mb-3">
                    <i class="fa-solid fa-link text-oasis-600 mr-1"></i>Proyectos Relacionados
                </h3>
                <div class="space-y-2">
                    {% for r in related %}
                    <a href="{% url 'repositorio:detalle' r.pk %}" class="related-card">
                        <p class="text-xs font-bold text-gray-800 leading-tight">{{ r.titulo|truncatechars:50 }}</p>
                        <p class="text-xs text-gray-400 mt-0.5">{{ r.autor }} · {{ r.votos }} votos</p>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- ═══ Lightbox ═════════════════════════════════════════════ -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <button class="lightbox-close"><i class="fa-solid fa-xmark"></i></button>
    <img id="lightbox-img" src="" alt="Preview">
</div>

<!-- ═══ Upload Modal ═════════════════════════════════════════ -->
{% if can_edit %}
<div class="upload-modal-bg" id="upload-modal">
    <div class="upload-modal" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">
                <i class="fa-solid fa-upload text-oasis-600 mr-1"></i>Subir Archivos
            </h3>
            <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
        </div>

        <form id="upload-form" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-4">
                <label class="text-sm font-semibold text-gray-700 mb-1 block">Version</label>
                <select name="version" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-oasis-500">
                    <option value="V1">V1 - Borrador</option>
                    <option value="V2">V2 - Revision</option>
                    <option value="FINAL">Version Final</option>
                </select>
            </div>

            <div class="drop-zone mb-4" id="drop-zone"
                 onclick="document.getElementById('file-input').click()">
                <i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-300 mb-2"></i>
                <p class="text-sm font-semibold text-gray-600">Arrastra archivos o haz clic aqui</p>
                <p class="text-xs text-gray-400 mt-1">PDF, codigo, imagenes, videos, modelos 3D (max 50MB)</p>
                <input type="file" id="file-input" name="archivos" multiple class="hidden"
                       onchange="updateFileList(this)">
            </div>

            <div id="file-list" class="space-y-1 mb-4"></div>

            <div id="upload-progress" class="hidden mb-3">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-full bg-oasis-500 rounded-full transition-all" id="upload-bar" style="width:0%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-1" id="upload-status">Subiendo...</p>
            </div>

            <button type="submit" class="w-full py-2.5 bg-oasis-600 text-white rounded-lg text-sm font-bold hover:bg-oasis-700 transition">
                <i class="fa-solid fa-upload mr-1"></i> Subir Archivos
            </button>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
// ── Lightbox ──
function openLightbox(src) {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').classList.add('active');
}
function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
}

// ── Vote ──
function voteProject(pk) {
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]');
    const token = csrf ? csrf.value : '{{ csrf_token }}';
    fetch(`/repositorio/proyecto/${pk}/votar/`, {
        method: 'POST',
        headers: {'X-CSRFToken': token, 'Content-Type': 'application/json'},
    })
    .then(r => r.json())
    .then(data => {
        if (data.ok) {
            document.getElementById('vote-count').textContent = data.votos;
            document.getElementById('vote-btn').classList.add('voted');
        }
    })
    .catch(() => alert('Error al votar'));
}

{% if can_edit %}
// ── Upload Modal ──
function openUploadModal() {
    document.getElementById('upload-modal').classList.add('active');
}
function closeUploadModal() {
    document.getElementById('upload-modal').classList.remove('active');
}
document.getElementById('upload-modal').addEventListener('click', function(e) {
    if (e.target === this) closeUploadModal();
});

// Drop zone
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');
['dragenter', 'dragover'].forEach(evt => {
    dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
});
['dragleave', 'drop'].forEach(evt => {
    dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.remove('drag-over'); });
});
dropZone.addEventListener('drop', e => {
    fileInput.files = e.dataTransfer.files;
    updateFileList(fileInput);
});

function updateFileList(input) {
    const list = document.getElementById('file-list');
    list.innerHTML = '';
    Array.from(input.files).forEach(f => {
        const size = f.size < 1024*1024
            ? (f.size/1024).toFixed(1) + ' KB'
            : (f.size/(1024*1024)).toFixed(1) + ' MB';
        list.innerHTML += `<div class="flex items-center gap-2 text-xs text-gray-600 px-2 py-1 bg-gray-50 rounded">
            <i class="fa-solid fa-file text-gray-400"></i>
            <span class="flex-1 truncate">${f.name}</span>
            <span class="text-gray-400">${size}</span>
        </div>`;
    });
}

// Upload form
document.getElementById('upload-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = new FormData(this);
    const progress = document.getElementById('upload-progress');
    const bar = document.getElementById('upload-bar');
    const status = document.getElementById('upload-status');
    progress.classList.remove('hidden');
    bar.style.width = '30%';
    status.textContent = 'Subiendo archivos...';

    fetch('/repositorio/proyecto/{{ proyecto.pk }}/subir/', {
        method: 'POST',
        headers: {'X-CSRFToken': form.get('csrfmiddlewaretoken')},
        body: form,
    })
    .then(r => r.json())
    .then(data => {
        bar.style.width = '100%';
        if (data.ok) {
            status.textContent = data.message;
            setTimeout(() => location.reload(), 1200);
        } else {
            status.textContent = data.error || 'Error al subir';
            bar.style.background = '#ef4444';
        }
    })
    .catch(() => {
        bar.style.width = '100%';
        bar.style.background = '#ef4444';
        status.textContent = 'Error de conexion';
    });
});
{% endif %}

// Keyboard: Escape closes lightbox/modal
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        closeLightbox();
        {% if can_edit %}closeUploadModal();{% endif %}
    }
});
</script>
{% endblock %}
